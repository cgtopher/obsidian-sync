<!doctype html><html><head><title>Mini RFC Camunda Workflow Engine</title><base href="../"><meta id="root-path" root-path="../"><link rel="icon" sizes="96x96" href="https://publish-01.obsidian.md/access/f786db9fac45774fa4f0d8112e232d67/favicon-96x96.png"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes,minimum-scale=1,maximum-scale=5"><meta charset="UTF-8"><link rel="stylesheet" href="lib/styles/obsidian-styles.css"><link rel="stylesheet" href="lib/styles/theme.css"><link rel="stylesheet" href="lib/styles/plugin-styles.css"><link rel="stylesheet" href="lib/styles/snippets.css"><link rel="stylesheet" href="lib/styles/generated-styles.css"><style></style><script src="lib/scripts/webpage.js"></script><script src="lib/scripts/generated.js"></script></head><body class="theme-dark mod-linux show-inline-title loading"><div class="webpage-container"><div class="sidebar-left sidebar"><div class="sidebar-container"><div class="sidebar-sizer"><div class="sidebar-content-positioner"><div class="sidebar-content"><div><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="tree-container file-tree mod-nav-indicator" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">obsidian-sync</span><button class="clickable-icon collapse-tree-button is-collapsed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area"><div class="tree-item mod-tree-folder mod-collapsible is-collapsed" data-depth="1"><div class="tree-item-contents"><a class="internal-link tree-item-link"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">Arbor Interview</span></a></div><div class="tree-item-children" style="display:none"><div class="tree-item mod-tree-file" data-depth="2"><div class="tree-item-contents"><a class="internal-link tree-item-link" href="arbor-interview/index.html"><span class="tree-item-title">index</span></a></div><div class="tree-item-children"></div></div><div class="tree-item mod-tree-file" data-depth="2"><div class="tree-item-contents"><a class="internal-link tree-item-link" href="arbor-interview/mini-rfc-camunda-workflow-engine.html"><span class="tree-item-title">Mini RFC Camunda Workflow Engine</span></a></div><div class="tree-item-children"></div></div><div class="tree-item mod-tree-file" data-depth="2"><div class="tree-item-contents"><a class="internal-link tree-item-link" href="arbor-interview/tech-doc-form-builder-service.html"><span class="tree-item-title">Tech Doc Form Builder Service</span></a></div><div class="tree-item-children"></div></div></div></div></div></div></div></div></div></div><div class="sidebar-gutter"><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div></div><div class="document-container show"><div class="markdown-preview-view markdown-rendered node-insert-event is-readable-line-width allow-fold-headings show-indentation-guide allow-fold-lists show-properties" tabindex="-1" style="tab-size:4"><style id="MJX-CHTML-styles"></style><div class="markdown-preview-sizer markdown-preview-section" style="min-height:125px"><div class="markdown-preview-pusher" style="width:1px;height:.1px;margin-bottom:0"></div><div class="mod-header"></div><div class="heading-wrapper"><h1 data-heading="Mini-RFC: Camunda Workflow Engine" class="heading" id="Mini-RFC:_Camunda_Workflow_Engine"><div class="heading-before"></div>Mini-RFC: Camunda Workflow Engine<div class="heading-after">...</div></h1><div class="heading-children"><div><p><strong>Authors:</strong></p></div><div><ul><li data-line="0"><a data-tooltip-position="top" aria-label="https://github.com/cgtopher" rel="noopener" class="external-link" href="https://github.com/cgtopher" target="_blank">@chrisgaunt</a></li></ul></div><div class="heading-wrapper"><h2 data-heading="Executive Summary" class="heading" id="Executive_Summary"><div class="heading-before"></div><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle" style="width:24px;max-width:100%"><path d="M3 8L12 17L21 8"></path></svg></div>Executive Summary<div class="heading-after">...</div></h2><div class="heading-children"><div><p><em>In order to enable the creation of complex workflows that are dependent on state, this proposes the use of <a data-tooltip-position="top" aria-label="https://camunda.com/platform-7/workflow-engine/" rel="noopener" class="external-link" href="https://camunda.com/platform-7/workflow-engine/" target="_blank">Camunda's Workflow Engine</a>. A library provided by Camunda that uses Business Process Management Notation (<a data-tooltip-position="top" aria-label="https://www.bpmn.org/" rel="noopener" class="external-link" href="https://www.bpmn.org/" target="_blank">BPMN</a>) to define the "paths" a form can take</em></p></div></div></div><div class="heading-wrapper"><h2 data-heading="Background" class="heading" id="Background"><div class="heading-before"></div><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle" style="width:24px;max-width:100%"><path d="M3 8L12 17L21 8"></path></svg></div>Background<div class="heading-after">...</div></h2><div class="heading-children"><div><p>Historically in this company, a home-brewed rules engine has been used to power the decision making around the paths the forms would travel. It uses Json form definitions that would be evaluated along with context objects on each call to the service (submitting answers to a page) behind a single endpoint to determine the next page a customer would be shown . While this solution works to power the forms our customers currently use, there are a number of issues with it.</p></div><div><ul><li data-line="0">The service has no real concept as to where data is located in state, as a result it must send the entire serialized context object to integrations, leaving the responsibility of figuring out the state of the form and what data is available to the receiving services/functions, resulting in buggy and difficult to test code</li><li data-line="1">There is no good way to query forms in progress, it often requires scripting to get a clear picture. Which isn't ideal particularly for monitoring</li><li data-line="2">These context evaluations, once a form is large enough, become expensive operations as the service would have to fetch and process the whole definition, which introduces latency</li></ul></div><div><p>Camunda's workflow engine helps to address these concerns</p></div><div><ul><li data-line="0">The engine has the concept of <a data-tooltip-position="top" aria-label="https://docs.camunda.org/manual/latest/user-guide/process-engine/variables/" rel="noopener" class="external-link" href="https://docs.camunda.org/manual/latest/user-guide/process-engine/variables/" target="_blank">Process Variables</a> and provides a Java API for querying them. These variables are scoped to the <a data-tooltip-position="top" aria-label="https://docs.camunda.org/manual/latest/user-guide/process-engine/process-engine-concepts/#process-instances" rel="noopener" class="external-link" href="https://docs.camunda.org/manual/latest/user-guide/process-engine/process-engine-concepts/#process-instances" target="_blank">Process Instances</a> and will make it possible to map data across pages and into integration points</li><li data-line="1">Above mentioned Process Instances are also easily queryable through the Java API, for which endpoints could be stood up to monitor instances in flight.</li><li data-line="2">It has a long development history with many enhancements for performance and reliability</li></ul></div></div></div><div class="heading-wrapper"><h2 data-heading="Proposed Implementation" class="heading" id="Proposed_Implementation"><div class="heading-before"></div><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle" style="width:24px;max-width:100%"><path d="M3 8L12 17L21 8"></path></svg></div>Proposed Implementation<div class="heading-after">...</div></h2><div class="heading-children"><div><p>The workflow engine accepts BPMN, which can be expressed both as XML or in code through the <a data-tooltip-position="top" aria-label="https://docs.camunda.org/manual/latest/user-guide/model-api/bpmn-model-api/create-a-model/" rel="noopener" class="external-link" href="https://docs.camunda.org/manual/latest/user-guide/model-api/bpmn-model-api/create-a-model/" target="_blank">builder api</a>, to create <a data-tooltip-position="top" aria-label="https://docs.camunda.org/manual/latest/user-guide/process-engine/process-engine-concepts/#process-definitions" rel="noopener" class="external-link" href="https://docs.camunda.org/manual/latest/user-guide/process-engine/process-engine-concepts/#process-definitions" target="_blank">Process Definitions</a>. A form designer service will be made to create these definitions, attaching page rendering data to <a data-tooltip-position="top" aria-label="https://docs.camunda.org/manual/7.20/reference/bpmn20/tasks/user-task/" rel="noopener" class="external-link" href="https://docs.camunda.org/manual/7.20/reference/bpmn20/tasks/user-task/" target="_blank">User Tasks</a> (basically a unit of work that waits for an interaction before proceeding to the next task).</p></div><div><p>A workflow service will be created to manage the interactions between the customer and the engine. The service will query for the next task, and return the data to be rendered by the front end. Once a new submission comes in for the form, it will submit the data for that page, which kicks off the next task.</p></div><div><p>In simplified terms, the code for creating an instance and fetching the data to render the page would look like this:</p></div><div><pre class="language-java" tabindex="0"><code class="language-java is-loaded"><span class="token comment">// Create new process instance based on id which could be mapped from a slug  </span>
<span class="token class-name">RuntimeService</span> runtimeService <span class="token operator">=</span> engine<span class="token punctuation">.</span><span class="token function">getRuntimeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token class-name">ProcessInstance</span> instance <span class="token operator">=</span> runtimeService
    <span class="token punctuation">.</span><span class="token function">createProcessInstanceById</span><span class="token punctuation">(</span><span class="token string">"&lt;Form Definition ID&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">return</span> instance<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
  
<span class="token comment">/*  
 Query for the task by the process instance ID, an ID can be stored in the  task's "formKey" field which is placed by default by Camunda 
*/</span>
<span class="token class-name">TaskService</span> taskService <span class="token operator">=</span> engine<span class="token punctuation">.</span><span class="token function">getTaskService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Task</span> task <span class="token operator">=</span> taskService<span class="token punctuation">.</span><span class="token function">createTaskQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">processInstanceId</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getProcessInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">singleResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">UUID</span> pageId <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">fromString</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getFormKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">return</span> formRepository<span class="token punctuation">.</span><span class="token function">getPageById</span><span class="token punctuation">(</span>pageId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p>Integrations can be attached to <a data-tooltip-position="top" aria-label="https://docs.camunda.org/manual/latest/reference/bpmn20/tasks/service-task/" rel="noopener" class="external-link" href="https://docs.camunda.org/manual/latest/reference/bpmn20/tasks/service-task/" target="_blank">Service Tasks</a> which are automatically executed while the service is querying for the next User Task. These tasks can be mapped to a <a data-tooltip-position="top" aria-label="https://docs.camunda.org/manual/7.20/user-guide/process-engine/delegation-code/#java-delegate" rel="noopener" class="external-link" href="https://docs.camunda.org/manual/7.20/user-guide/process-engine/delegation-code/#java-delegate" target="_blank">Java Delegate</a> that will be responsible for making REST requests or executing AWS lambdas, and map the results back into the process variables in the instance.</p></div></div></div></div></div><div class="heading-wrapper"><h1 data-heading="Drawbacks" class="heading" id="Drawbacks"><div class="heading-before"></div>Drawbacks<div class="heading-after">...</div></h1><div class="heading-children"><div><p>Since the service task execution will happen while a thread is held open to query for the next task, the Java delegates will need to carefully handle timeouts and exceptions. If there are too many concurrent service tasks running, it could hog system resources and risk increased latency overall.</p></div><div><p>Considerations to make:</p></div><div><ul><li data-line="0">Extra monitoring for execution time, number of service tasks running, as well as overall request latency</li><li data-line="1">Thinking through async approaches, to perhaps send an event from the server when the next page is ready, rather than holding the connection open</li></ul></div><div><p>For now configuring the K8's deployment such that it autoscales at a relatively low cpu utilization threshold, should provide some reduction in impact of bursts of traffic.</p></div><div class="heading-wrapper"><h2 data-heading="Alternatives" class="heading" id="Alternatives"><div class="heading-before"></div><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle" style="width:24px;max-width:100%"><path d="M3 8L12 17L21 8"></path></svg></div>Alternatives<div class="heading-after">...</div></h2><div class="heading-children"><div class="heading-wrapper"><h5 data-heading="Flowable" class="heading" id="Flowable"><div class="heading-before"></div><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle" style="width:24px;max-width:100%"><path d="M3 8L12 17L21 8"></path></svg></div>Flowable<div class="heading-after">...</div></h5><div class="heading-children"><div><ul><li data-line="0">Works very similarly to Camunda (and was in fact created by some of Camunda's developers)</li><li data-line="1">Has more support for tying in Java executables to process definitions</li></ul></div><div><p>[Flowable Docs]](<a rel="noopener" class="external-link" href="https://documentation.flowable.com/latest/?_gl=1*10qw47*_ga*MTY1Njk2MjA2MC4xNzA2NjY3MTk5*_ga_16FH60X0R3*MTcwNjc0NTM1OC4yLjAuMTcwNjc0NTM1OC42MC4wLjA." target="_blank">https://documentation.flowable.com/latest/?_gl=1*10qw47*_ga*MTY1Njk2MjA2MC4xNzA2NjY3MTk5*_ga_16FH60X0R3*MTcwNjc0NTM1OC4yLjAuMTcwNjc0NTM1OC42MC4wLjA.</a>)</p></div><div><p>The automations team is currently using Camunda to orchestrate automations for customers. Since Flowable is such a similar product, it doesn't make much sense to use it as consistent tooling should make it easier to tie the products together in the future.</p></div></div></div><div class="heading-wrapper"><h5 data-heading="Spring State Machine" class="heading" id="Spring_State_Machine"><div class="heading-before"></div><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle" style="width:24px;max-width:100%"><path d="M3 8L12 17L21 8"></path></svg></div>Spring State Machine<div class="heading-after">...</div></h5><div class="heading-children"><div><ul><li data-line="0">First class Spring Boot support</li><li data-line="1">Simple API for interacting with states</li></ul></div><div><p><a data-tooltip-position="top" aria-label="https://spring.io/projects/spring-statemachine" rel="noopener" class="external-link" href="https://spring.io/projects/spring-statemachine" target="_blank">Spring State Machine Docs</a></p></div><div><p>Using Spring State Machine would grant a lot of flexibility in how forms are interacted with, however states are defined in code only, so is not as easily serializable. This library is also more general purpose than for just powering workflows, so there would be a need for more underlying custom logic, adding complexity and hurting maintainability.</p></div></div></div></div></div><div class="heading-wrapper"><h2 data-heading="Unresolved questions" class="heading" id="Unresolved_questions"><div class="heading-before"></div><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle" style="width:24px;max-width:100%"><path d="M3 8L12 17L21 8"></path></svg></div>Unresolved questions<div class="heading-after">...</div></h2><div class="heading-children"><div><ul><li data-line="0">What format should the pages use for rendering data? This should be something something that could be deserialized into Java objects for validation purposes.<ul><li data-line="1"><a data-tooltip-position="top" aria-label="https://jsonforms.io/" rel="noopener" class="external-link" href="https://jsonforms.io/" target="_blank">JSONForms</a> is being considered for this purpose as there are Java libraries for interacting with JSON schema, which it operates on</li></ul></li><li data-line="2">Should page data be embedded in the form definitions or separately in its own table, and side-by-side with the BPMN in the deployment request?</li></ul></div><div class="mod-footer"></div></div></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-gutter"><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-container"><div class="sidebar-sizer"><div class="sidebar-content-positioner"><div class="sidebar-content"><div class="tree-container outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area"><div class="tree-item" data-depth="1"><div class="tree-item-contents"><a class="internal-link tree-item-link" href="#Mini-RFC:_Camunda_Workflow_Engine"><span class="tree-item-title"><p>Mini-RFC: Camunda Workflow Engine</p></span></a></div><div class="tree-item-children"><div class="tree-item" data-depth="2"><div class="tree-item-contents"><a class="internal-link tree-item-link" href="#Executive_Summary"><span class="tree-item-title"><p>Executive Summary</p></span></a></div><div class="tree-item-children"></div></div><div class="tree-item" data-depth="2"><div class="tree-item-contents"><a class="internal-link tree-item-link" href="#Background"><span class="tree-item-title"><p>Background</p></span></a></div><div class="tree-item-children"></div></div><div class="tree-item" data-depth="2"><div class="tree-item-contents"><a class="internal-link tree-item-link" href="#Proposed_Implementation"><span class="tree-item-title"><p>Proposed Implementation</p></span></a></div><div class="tree-item-children"></div></div></div></div><div class="tree-item" data-depth="1"><div class="tree-item-contents"><a class="internal-link tree-item-link" href="#Drawbacks"><span class="tree-item-title"><p>Drawbacks</p></span></a></div><div class="tree-item-children"><div class="tree-item mod-collapsible" data-depth="2"><div class="tree-item-contents"><a class="internal-link tree-item-link" href="#Alternatives"><div class="tree-item-icon collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title"><p>Alternatives</p></span></a></div><div class="tree-item-children"><div class="tree-item" data-depth="5"><div class="tree-item-contents"><a class="internal-link tree-item-link" href="#Flowable"><span class="tree-item-title"><p>Flowable</p></span></a></div><div class="tree-item-children"></div></div><div class="tree-item" data-depth="5"><div class="tree-item-contents"><a class="internal-link tree-item-link" href="#Spring_State_Machine"><span class="tree-item-title"><p>Spring State Machine</p></span></a></div><div class="tree-item-children"></div></div></div></div><div class="tree-item" data-depth="2"><div class="tree-item-contents"><a class="internal-link tree-item-link" href="#Unresolved_questions"><span class="tree-item-title"><p>Unresolved questions</p></span></a></div><div class="tree-item-children"></div></div></div></div></div></div></div></div></div></div></div></div></body></html>